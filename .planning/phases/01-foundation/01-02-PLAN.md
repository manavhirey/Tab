---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .env.local
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - middleware.ts
autonomous: true
user_setup:
  - service: supabase
    why: "Database and authentication backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
    dashboard_config:
      - task: "Create new Supabase project"
        location: "https://supabase.com/dashboard -> New Project"

must_haves:
  truths:
    - "Supabase browser client can be created"
    - "Supabase server client can be created"
    - "Middleware refreshes auth tokens on requests"
    - "Environment variables are loaded correctly"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createClient"]
      min_lines: 8
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client"
      exports: ["createClient"]
      min_lines: 15
    - path: "middleware.ts"
      provides: "Auth token refresh middleware"
      contains: "createServerClient"
      min_lines: 30
    - path: ".env.local"
      provides: "Environment variables"
      contains: "NEXT_PUBLIC_SUPABASE_URL"
  key_links:
    - from: "src/lib/supabase/client.ts"
      to: ".env.local"
      via: "process.env"
      pattern: "process\\.env\\.NEXT_PUBLIC_SUPABASE"
    - from: "src/lib/supabase/server.ts"
      to: "next/headers"
      via: "cookies import"
      pattern: "import.*cookies.*from.*next/headers"
    - from: "middleware.ts"
      to: "@supabase/ssr"
      via: "createServerClient"
      pattern: "import.*createServerClient.*from.*@supabase/ssr"
---

<objective>
Set up Supabase client utilities and auth middleware for server-side authentication.

Purpose: Enable database connectivity and auth session management using Supabase SSR patterns.
Output: Browser client, server client, and middleware configured for Supabase auth.
</objective>

<execution_context>
@/Users/manavhirey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/manavhirey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase packages and create environment template</name>
  <files>
    - package.json
    - .env.local
    - .env.example
  </files>
  <action>
Install Supabase packages:

```bash
cd /Users/manavhirey/Documents/Code/Tab
npm install @supabase/supabase-js @supabase/ssr
```

Create .env.local with placeholder values (user will replace with real values):

```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

Create .env.example for version control (same structure, no real values):

```bash
# .env.example
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
```

Add .env.local to .gitignore if not already present:

```bash
echo ".env.local" >> .gitignore
```
  </action>
  <verify>
```bash
cd /Users/manavhirey/Documents/Code/Tab
npm ls @supabase/supabase-js @supabase/ssr
cat .env.local | grep SUPABASE
```
Packages installed, env file exists with SUPABASE variables.
  </verify>
  <done>
Supabase packages installed. Environment template created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase client utilities</name>
  <files>
    - src/lib/supabase/client.ts
    - src/lib/supabase/server.ts
  </files>
  <action>
Create the supabase directory and client files:

```bash
mkdir -p /Users/manavhirey/Documents/Code/Tab/src/lib/supabase
```

Create browser client (src/lib/supabase/client.ts):

```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

Create server client (src/lib/supabase/server.ts):

```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    }
  )
}
```

IMPORTANT: Use getAll() and setAll() methods only - not individual get/set/remove methods (per @supabase/ssr requirements).
  </action>
  <verify>
```bash
cd /Users/manavhirey/Documents/Code/Tab
cat src/lib/supabase/client.ts | grep "createBrowserClient"
cat src/lib/supabase/server.ts | grep "createServerClient"
npx tsc --noEmit 2>&1 | head -10
```
Both files exist with correct imports. TypeScript compiles without errors.
  </verify>
  <done>
Browser and server Supabase clients created with SSR-compatible cookie handling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create auth middleware</name>
  <files>
    - middleware.ts
  </files>
  <action>
Create middleware.ts at project root (NOT in src/app/):

```typescript
// middleware.ts
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value))
          supabaseResponse = NextResponse.next({
            request,
          })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // IMPORTANT: Do not remove this line - it refreshes the session
  // and ensures the user object is available in server components
  const {
    data: { user },
  } = await supabase.auth.getUser()

  // For now, allow all routes (route protection added in Phase 2: Auth)
  // This middleware just ensures session tokens are refreshed

  return supabaseResponse
}

export const config = {
  matcher: [
    /*
     * Match all request paths except:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - images - .svg, .png, .jpg, .jpeg, .gif, .webp
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

Note: Route protection (redirect unauthenticated users) will be added in Phase 2: Authentication. This middleware just handles session refresh for now.
  </action>
  <verify>
```bash
cd /Users/manavhirey/Documents/Code/Tab
cat middleware.ts | grep "createServerClient"
cat middleware.ts | grep "supabase.auth.getUser"
npm run build 2>&1 | tail -10
```
Middleware exists with correct Supabase client creation and getUser call. Build succeeds.
  </verify>
  <done>
Auth middleware created at project root. Session tokens will be refreshed on each request.
  </done>
</task>

</tasks>

<verification>
1. `npm ls @supabase/supabase-js @supabase/ssr` shows packages installed
2. `src/lib/supabase/client.ts` exports createClient function
3. `src/lib/supabase/server.ts` exports async createClient function
4. `middleware.ts` exists at project root (not src/app/)
5. `npm run build` succeeds (TypeScript compiles)
6. No "Cannot find module" errors for Supabase imports
</verification>

<success_criteria>
- @supabase/supabase-js and @supabase/ssr packages installed
- Browser client utility created at src/lib/supabase/client.ts
- Server client utility created at src/lib/supabase/server.ts
- Auth middleware created at project root
- Environment template (.env.local) exists with Supabase variable placeholders
- Build succeeds without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
